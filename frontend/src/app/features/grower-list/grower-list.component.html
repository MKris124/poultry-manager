<div class="layout-content" style="max-width: 1400px; margin: 40px auto; padding: 0 20px;">
    
    <div class="flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h1 class="font-bold m-0 text-3xl">Nevelők</h1>
            <p class="text-500 mt-2 m-0">Nevelők és beszállítóik listája</p>
        </div>

        <div class="flex align-items-center gap-3">
            <span class="relative block" style="min-width: 250px;">
                <i class="pi pi-search text-500 absolute" style="top: 50%; transform: translateY(-50%); left: 1rem;"></i>
                <input type="text" pInputText placeholder="Keresés (Név, Város)..." 
                       (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                       class="w-full border-round-2xl pl-6 shadow-1 border-none py-2" />
            </span>

            <p-button label="Új Nevelő" icon="pi pi-plus" 
                      (click)="createDialog.show()" 
                      styleClass="border-round-2xl px-4 bg-primary border-none shadow-2"></p-button>
        </div>
    </div>
    
    <div class="modern-card fade-in">
        <p-table #dt [value]="growers" 
                 dataKey="id" 
                 [rowHover]="true" 
                 responsiveLayout="scroll"
                 [expandedRowKeys]="expandedRows"
                 [globalFilterFields]="['name', 'city']"> 
                 
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 3rem"></th> <th pSortableColumn="name">Nevelő Neve <p-sortIcon field="name"></p-sortIcon></th>
                    <th pSortableColumn="city">Település <p-sortIcon field="city"></p-sortIcon></th>
                    <th>Partnerek száma</th>
                    <th></th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-grower>
                <tr class="cursor-pointer table-row-hover" (click)="openGrowerStats(grower)">
                    <td (click)="$event.stopPropagation()"> 
                        <button type="button" pButton pRipple 
                                class="p-button-text p-button-rounded p-button-plain" 
                                [icon]="expandedRows[grower.id] ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                (click)="toggleRow(grower, $event)">
                        </button>
                    </td>
                    
                    <td class="font-bold text-lg text-900">{{grower.name}}</td>
                    
                    <td>
                        <span *ngIf="grower.city" class="county-badge surface-200 text-700 font-medium">
                            <i class="pi pi-map-marker text-xs mr-1"></i>{{grower.city}}
                        </span>
                        <span *ngIf="!grower.city" class="text-400 italic">Nincs megadva</span>
                    </td>
                    
                    <td>
                        <span class="inline-flex align-items-center gap-2 px-2 py-1 border-round-2xl surface-100 text-600 font-medium">
                            <i class="pi pi-users text-sm"></i>
                            {{grower.partners?.length || 0}} db partner
                        </span>
                    </td>
                    
                    <td class="text-right">
                        <div class="flex justify-content-end gap-2">
                            <button pButton 
                                    icon="pi pi-pencil" 
                                    pTooltip="Szerkesztés" 
                                    tooltipPosition="top"
                                    class="p-button-rounded p-button-warning p-button-text hover:surface-100"
                                    (click)="editGrower(grower, $event)"></button>
                        
                            <button pButton 
                                    icon="pi pi-trash" 
                                    pTooltip="Törlés" 
                                    tooltipPosition="top"
                                    class="p-button-rounded p-button-danger p-button-text hover:surface-100"
                                    (click)="deleteGrower(grower, $event)"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="expandedrow" let-grower>
                <tr>
                    <td colspan="5" class="p-0">
                        <div class="p-3 surface-50 shadow-inner" style="border-left: 4px solid var(--primary-color)">
                            <div class="flex align-items-center gap-2 mb-3">
                                <i class="pi pi-link text-primary text-xl"></i>
                                <h4 class="m-0 text-700">Partnerek</h4>
                            </div>
                            
                            <p-table [value]="grower.partners" styleClass="p-datatable-sm surface-card shadow-1 border-round" dataKey="id">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th style="width: 40%">Partner Név</th>
                                        <th style="width: 30%">Telephelyek</th>
                                        <th class="text-right">Beszállított db (ettől a nevelőtől)</th>
                                    </tr>
                                </ng-template>
                                
                                <ng-template pTemplate="body" let-partner>
                                    <tr class="hover:surface-100 transition-duration-100">
                                        <td class="font-bold text-primary-700 text-lg">
                                            {{partner.name}}
                                        </td>
                                        
                                        <td>
                                            <div *ngIf="partner.locations && partner.locations.length > 0; else noLoc">
                                                <div *ngFor="let loc of partner.locations" class="text-sm text-600 mb-1">
                                                    <i class="pi pi-building text-xs mr-1 opacity-60"></i>{{loc.city}}
                                                </div>
                                            </div>
                                            <ng-template #noLoc><span class="text-400 italic text-sm">Nincs rögzített telephely</span></ng-template>
                                        </td>
                                        
                                        <td class="text-right">
                                            <span class="font-bold text-900 text-lg">{{partner.totalQuantity | number}}</span>
                                            <span class="text-500 ml-1">db</span>
                                        </td>
                                    </tr>
                                </ng-template>
                                
                                <ng-template pTemplate="emptymessage">
                                    <tr>
                                        <td colspan="3" class="text-center p-4 text-500">
                                            <i class="pi pi-info-circle mr-2"></i>Nincs partner rögzítve ehhez a nevelőhöz.
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </td>
                </tr>
            </ng-template>

        </p-table>
    </div>
</div>

<app-partner-sidebar
    [(visible)]="sidebarVisible"
    [partner]="selectedGrower"
    (closed)="onSidebarHide()">
</app-partner-sidebar>

<app-grower-create-dialog #createDialog (onSave)="loadGrowers()"></app-grower-create-dialog>
<app-partner-sidebar
    [(visible)]="sidebarVisible"
    [partner]="selectedGrower"
    (closed)="onSidebarHide()">
</app-partner-sidebar>

<app-grower-create-dialog #createDialog (onSave)="loadGrowers()"></app-grower-create-dialog>

<p-toast position="top-center"></p-toast>
<p-confirmPopup></p-confirmPopup>